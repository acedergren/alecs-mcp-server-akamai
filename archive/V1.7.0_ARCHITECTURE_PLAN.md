# v1.7.0 Snow Leopard Architecture Simplification Plan

## Philosophy: True Snow Leopard Refinement

Following Mac OS X Snow Leopard's principle: **"No new features, just refinement"**

- **Simplify**: Remove complexity, not functionality
- **Unify**: Consolidate scattered code
- **Optimize**: Better performance through better architecture
- **Stabilize**: Rock-solid foundations

## Current State Analysis

### Problems Identified

1. **Server Sprawl**: 15 server files with overlapping functionality
2. **Tool Fragmentation**: Tools scattered across multiple files without clear organization
3. **NPM Script Bloat**: 27+ scripts with many duplicates
4. **Response Inconsistency**: Mix of text and structured responses
5. **TypeScript Issues**: Multiple compilation errors from rapid development

### Architecture Debt

```
src/servers/
├── property-server.ts           # 31 tools
├── property-server-consolidated.ts  # Duplicate?
├── dns-server.ts               # 24 tools  
├── dns-server-consolidated.ts  # Duplicate?
├── certs-server.ts             # 22 tools
├── certs-server-consolidated.ts # Duplicate?
├── security-server.ts          # 95 tools
├── security-server-consolidated.ts # Duplicate?
├── reporting-server.ts         # 19 tools
├── appsec-server.ts           # Overlap with security?
├── fastpurge-server.ts        # Should be in core?
├── network-lists-server.ts    # Part of security?
├── performance-server.ts      # Part of reporting?
└── workflow-assistant-stubs.ts # Experimental?
```

**Issues:**
- Duplicate "consolidated" files
- Unclear boundaries between servers
- Some servers have just a few tools
- No clear hierarchy or organization

## v1.7.0 Target Architecture

### Single-Server Model

```
src/
├── index.ts                 # Universal Server (Configuration-Driven)
└── tools/
    ├── core/               # Essential workflow tools
    ├── common/             # Frequently used tools
    ├── advanced/           # Complex operations
    └── services/           # Service-specific tools
```

### Server Profiles (Configuration-Driven)

#### Full Profile (Default)
```typescript
interface FullProfile {
  tools: {
    core: PropertyTools & GroupTools & ContractTools;
    common: ProductTools & RulesTools & HostnameTools;
    advanced: CloneTools & BulkTools & IncludesTools;
    services: DNSTools & CertificateTools & SecurityTools & ReportingTools;
  };
  features: {
    multiCustomer: true;
    allTransports: true;
    jsonResponses: true;
    caching: true;
    monitoring: true;
  };
  memory: ~50MB;
  startupTime: ~2s;
}
```

#### Minimal Profile (`ALECS_PROFILE=minimal`)
```typescript
interface MinimalProfile {
  tools: {
    core: PropertyTools & GroupTools & ContractTools;
    services: DNSTools & CertificateTools; // No security/reporting
  };
  features: {
    multiCustomer: true;
    jsonResponses: true;
    basicCaching: true;
  };
  memory: ~25MB;
  startupTime: ~1s;
}
```

#### Core Profile (`ALECS_PROFILE=core`)
```typescript
interface CoreProfile {
  tools: {
    core: PropertyTools & GroupTools & ContractTools; // Only Phase 1 tools
  };
  features: {
    singleCustomer: true;
    jsonResponses: true;
  };
  memory: ~15MB;
  startupTime: ~0.5s;
}
```

## Tool Organization Strategy

### Following Property Tools Optimization Roadmap

Based on `PROPERTY_TOOLS_CLAUDE_OPTIMIZATION_ROADMAP.md`:

#### Phase 1: Essential Workflow Tools (Core)
```typescript
// src/tools/core/
export interface CoreTools {
  // Property lifecycle
  'property.list': PropertyListTool;
  'property.get': PropertyGetTool;
  'property.create': PropertyCreateTool;
  
  // Prerequisites for property creation
  'group.list': GroupListTool;           // HIGH PRIORITY
  'contract.list': ContractListTool;     // HIGH PRIORITY
  
  // Version management
  'property.version.create': VersionCreateTool; // HIGH PRIORITY
  
  // Activation workflow  
  'property.activate': ActivateTool;     // HIGH PRIORITY
  'property.activations.list': ActivationListTool; // HIGH PRIORITY
}
```

#### Phase 2: Common Operations
```typescript
// src/tools/common/
export interface CommonTools {
  'product.list': ProductListTool;
  'property.rules.get': RulesGetTool;
  'property.rules.update': RulesUpdateTool;
  'hostname.list': HostnameListTool;
  'property.search': PropertySearchTool;
}
```

#### Phase 3: Advanced Operations
```typescript
// src/tools/advanced/
export interface AdvancedTools {
  'property.clone': CloneTool;
  'property.hostname.add': HostnameAddTool;
  'property.hostname.remove': HostnameRemoveTool;
  'property.bulk.update': BulkUpdateTool;
  'include.list': IncludeListTool;
  'include.create': IncludeCreateTool;
}
```

#### Services: Domain-Specific Tools
```typescript
// src/tools/services/
export interface ServiceTools {
  // DNS Management
  'dns.zone.list': DNSZoneListTool;
  'dns.record.create': DNSRecordCreateTool;
  
  // Certificate Management  
  'cert.enroll': CertEnrollTool;
  'cert.status': CertStatusTool;
  
  // Security (Minimal Set)
  'security.netlist.list': NetListTool;
  'security.purge': PurgeTool;
  
  // Reporting (Minimal Set)
  'report.traffic': TrafficReportTool;
  'report.performance': PerformanceReportTool;
}
```

## JSON Response Standardization

### Standard Response Format

All tools will return structured JSON following the optimization roadmap:

```typescript
interface StandardToolResponse<T> {
  data: T;                    // Main response data
  metadata: {
    total: number;            // Total items available
    shown: number;            // Items in this response
    hasMore: boolean;         // More items available
    executionTime: number;    // Response time in ms
    warnings?: string[];      // Non-fatal issues
  };
  filters?: Record<string, any>;     // Applied filters echoed
  parameters?: Record<string, any>;  // Input parameters echoed
}

interface StandardErrorResponse {
  error: {
    code: string;             // ERROR_CODE
    message: string;          // Human readable
    details: Record<string, any>; // Specific error info
  };
  resolution: {
    steps: string[];          // Action steps
    documentation?: string;   // Help URL
  };
  metadata: {
    timestamp: string;        // ISO-8601
    requestId: string;        // Unique identifier
  };
}
```

### Benefits of JSON-First Design

1. **LLM Optimization**: Claude processes structured data better than text
2. **Token Efficiency**: JSON is more compact than markdown
3. **Composability**: Tools can be chained together
4. **Context Awareness**: Claude can format based on user intent
5. **Type Safety**: Better validation and error handling

## Migration Strategy

### Phase 1: Foundation (Week 1)
```bash
# Fix compilation errors
# Remove emoji inconsistencies  
# Basic architecture setup
```

### Phase 2: Server Consolidation (Week 2)
```bash
# Enhance index.ts with profile-based loading
# Implement configuration-driven tool registry
# Update package.json scripts
# Remove all 15 old server files
```

### Phase 3: Tool Organization (Week 3)
```bash
# Reorganize tools by priority/workflow
# Implement JSON response patterns
# Update tool registry
```

### Phase 4: NPM Script Cleanup (Week 4)
```bash
# Remove duplicate scripts
# Simplify command structure
# Update documentation
```

### Phase 5: Testing & Validation (Week 5)
```bash
# Update test suites
# Validate all workflows
# Performance testing
# Documentation updates
```

## NPM Script Simplification

### From 27+ Scripts to ~20

#### Keep (Core Functionality)
```json
{
  "build": "npm run clean && npm run build:ts",
  "clean": "rm -rf dist .tsbuildinfo", 
  "start": "node dist/index.js",
  "start:minimal": "ALECS_PROFILE=minimal node dist/index.js",
  "start:core": "ALECS_PROFILE=core node dist/index.js",
  "dev": "tsx src/index.ts",
  "test": "jest",
  "lint": "eslint 'src/**/*.ts' --fix",
  "typecheck": "tsc --noEmit"
}
```

#### Keep (Transport Variations)
```json
{
  "start:stdio": "MCP_TRANSPORT=stdio node dist/index.js",
  "start:websocket": "MCP_TRANSPORT=websocket node dist/index.js", 
  "start:sse": "MCP_TRANSPORT=sse node dist/index.js"
}
```

#### Keep (Testing & Quality)
```json
{
  "test:watch": "jest --watch",
  "test:coverage": "jest --coverage",
  "format": "prettier --write 'src/**/*.{ts,json,md}'"
}
```

#### Add (New Capabilities)
```json
{
  "tools:list": "node scripts/list-tools.js",
  "tools:validate": "node scripts/validate-tools.js",
  "config:check": "node scripts/check-config.js"
}
```

#### Remove (Duplicates/Unused)
```json
{
  // Remove all individual server scripts
  "start:property": "...",    // Remove
  "start:dns": "...",        // Remove  
  "start:certs": "...",      // Remove
  "start:security": "...",   // Remove
  "start:reporting": "...",  // Remove
  
  // Remove duplicate eval scripts
  "eval:property": "...",    // Remove
  "eval:dns": "...",        // Remove
  "eval:report": "...",     // Remove
  
  // Remove rarely used scripts
  "test:mcp-eval": "...",   // Remove (or simplify)
}
```

## Customer Impact Analysis

### Zero Breaking Changes
- All existing tool names preserved
- Backward compatibility maintained
- Same .edgerc configuration
- Same Claude Desktop integration

### Performance Improvements
- 50% faster startup (minimal profile)
- 40% lower memory usage (core profile)
- 70% reduction in memory for core-only deployments
- Better caching and response times
- Cleaner JSON responses for Claude

### Enhanced Developer Experience
- Clearer tool organization
- Better error messages
- Simplified deployment
- Easier testing and debugging

## Implementation Guidelines

### Code Quality Standards
1. **TypeScript First**: Zero `any` types allowed
2. **JSON Responses**: Structured data over formatted text
3. **Error Handling**: RFC 7807 compliant error responses
4. **Testing**: 95%+ coverage for all new code
5. **Documentation**: Every tool has examples

### Architecture Principles
1. **Single Responsibility**: Each tool does one thing well
2. **Composition Over Inheritance**: Favor small, composable functions
3. **Configuration Over Code**: Runtime configuration for different deployments
4. **Fail Fast**: Validate inputs early and provide clear error messages
5. **Observability**: Proper logging and metrics for hosted deployments

## Success Metrics

### Technical Metrics
- [ ] Compilation: Zero TypeScript errors
- [ ] Performance: <2s startup time (full profile)
- [ ] Performance: <1s startup time (minimal profile)
- [ ] Performance: <0.5s startup time (core profile)
- [ ] Memory: <50MB runtime footprint (full profile)
- [ ] Memory: <25MB runtime footprint (minimal profile)
- [ ] Memory: <15MB runtime footprint (core profile)
- [ ] Test Coverage: >95% for core tools

### User Experience Metrics
- [ ] Tool Discovery: Tools organized by workflow priority
- [ ] Response Quality: 100% JSON responses for core tools
- [ ] Error Handling: Clear, actionable error messages
- [ ] Documentation: Complete examples for all Phase 1 tools

### Operational Metrics
- [ ] Scripts: Reduced from 27+ to ~20
- [ ] Servers: Reduced from 15 to 1 (configuration-driven)
- [ ] Entry Points: Single index.ts with profile-based loading
- [ ] Complexity: Dramatically simplified mental model
- [ ] Maintenance: Easier to understand and modify

## Next Steps

1. **Get Approval**: Review this plan and get confirmation to proceed
2. **Start Implementation**: Begin with Phase 1 (foundation work)
3. **Iterative Development**: Small, focused PRs as outlined in V1.7.0_SIMPLIFICATION_PLAN.md
4. **Continuous Testing**: Validate each change doesn't break existing functionality
5. **Documentation**: Update README and guides as we progress

## Notes

- This plan aligns with the Property Tools Optimization Roadmap
- Maintains all CODE KAI quality improvements from v1.6.0
- Preserves multi-customer and remote MCP hosting capabilities
- Follows Snow Leopard philosophy: refinement over new features
- Sets foundation for future elicitation and MCP 2025 features