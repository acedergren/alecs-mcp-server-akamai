name: Dependency Update

on:
  schedule:
    # Run every Monday at 3 AM UTC
    - cron: '0 3 * * 1'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  update-dependencies:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Use Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Update dependencies
      run: |
        # Update npm itself
        npm install -g npm@latest
        
        # Update dependencies
        npx npm-check-updates -u --target minor
        npm install
        npm audit fix || true
    
    - name: Run tests
      run: |
        npm run build
        npm test
        npm run lint:check || true
        npm run format:check || true
    
    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: 'chore: update dependencies'
        title: 'chore: automated dependency updates'
        body: |
          ## Automated Dependency Updates
          
          This PR contains automated dependency updates performed by the weekly maintenance job.
          
          ### Changes
          - Updated npm dependencies to their latest minor versions
          - Applied any available security fixes
          
          ### Validation
          - ✅ Build successful
          - ✅ Tests passing
          - ✅ Linting checked
          
          Please review the changes and ensure everything works as expected before merging.
        branch: deps/automated-update
        delete-branch: true
        labels: |
          dependencies
          automated
        reviewers: |
          ${{ github.repository_owner }}

  security-audit:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Use Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run security audit
      run: |
        # Create audit report
        npm audit --json > audit-report.json || true
        
        # Check for critical vulnerabilities
        CRITICAL=$(cat audit-report.json | jq '.metadata.vulnerabilities.critical // 0')
        HIGH=$(cat audit-report.json | jq '.metadata.vulnerabilities.high // 0')
        
        echo "## Security Audit Report" >> $GITHUB_STEP_SUMMARY
        echo "- Critical vulnerabilities: $CRITICAL" >> $GITHUB_STEP_SUMMARY
        echo "- High vulnerabilities: $HIGH" >> $GITHUB_STEP_SUMMARY
        
        if [ "$CRITICAL" -gt 0 ]; then
          echo "❌ Critical vulnerabilities found!" >> $GITHUB_STEP_SUMMARY
          exit 1
        fi
    
    - name: Upload audit report
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: security-audit-report
        path: audit-report.json
        retention-days: 30